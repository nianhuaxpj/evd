<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Tunnel & Display Example</title>
    <meta name="description" content="Java SSH Tunnel, VNC / RDP display example">
    <meta name="author" content="Jakob A. Dam">
    <meta name="viewport" content="width=device-width; initial-scale=1.0">
    <style>
input {
  width: 200px;
  padding: 4px 0px 4px 0px;
  margin: 5px 5px 0px 0px;
  display: block;
}
form {
  margin: 5px 10px 0px 0px;
}
    </style>
  </head>
  <body>
    <nav></nav>
    <h1>VNC or RDP through SSH in the browser</h1>

    <form>
      <input id="host" type="text" required="required" placeholder="host name" value="valve001.irigo.com" />
      <input id="localport" type="text" required="required" placeholder="local port" value="5900" />
      <input id="remoteip" type="text" required="required" placeholder="remote ip" value="10.0.0.112" />
      <input id="remoteport" type="text" name="remoteport" required="required" placeholder="remote port" value="6107" />
      <input id="username" type="text" name="username" required="required" placeholder="username" value="jakob"/>

      <select id="type">
        <option value="vnc">vnc</option>
        <option value="rdp">rdp</option>
      </select>

      <select id="screensize">
        <option value="800x600">800x600</option>
        <option value="1024x768">1024x768</option>
        <option value="1280x1024">1280x1024</option>
      </select>

      <select id="lang">
<option value="ar">ar</option>
<option value="da" selected="selected">da</option>
<option value="de">de</option>
<option value="en-gb">en-gb</option>
<option value="en-us">en-us</option>
<option value="es">es</option>
<option value="fi">fi</option>
<option value="fr">fr</option>
<option value="fr-be">fr-be</option>
<option value="hr">hr</option>
<option value="it">it</option>
<option value="ja">ja</option>
<option value="lt">lt</option>
<option value="lv">lv</option>
<option value="mk">mk</option>
<option value="no">no</option>
<option value="pl">pl</option>
<option value="pt">pt</option>
<option value="pt-br">pt-br</option>
<option value="ru">ru</option>
<option value="sl">sl</option>
<option value="sv">sv</option>
<option value="tk">tk</option>
<option value="tr">tr</option>
      <select>
    </form>

    <button id="startButton">Start Tunnel</button>

    <div id="applet" style="display:none" />

    <footer></footer> 
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script>
String.prototype.substitute = function(/*Object*/map){
	return this.replace(/\$\{([^\s\:\}]+)(?:\:([^\s\:\}]+))?\}/g,
		function(match, key, format){
			var value = map[key];
			return value.toString();
		}); // String
};

var display = {
  create: function(args){
    var t = [
'<applet archive="/applet/steam.jar?v=' + new Date().getTime() + '" id="tunnel" code="Display" codebase="/applet/steam.jar" width="1" height="1">',
  '<param name="ip" value="localhost" />',
  '<param name="port" value="${localport}" />',
  '<param name="type" value="${type}" />',
  '<param name="screensize" value="${screensize}" />',
  '<param name="lang" value="${lang}" />',
  '<param name="windowtitle" value="${windowtitle}" />',
        
'</applet>'].join('');
    $('#applet').after(t.substitute(args));
  }
};

var tunnel = {
  subscribers: {},

  subscribe: function(/*String*/ event_name, /*Function*/ fct){
    var list = this.subscribers[event_name] || [];
    list.push(fct);
    this.subscribers[event_name] = list;
  },

  publish: function(event, message){
    $.each(this.subscribers[event], function(i, fct){
       fct(message);
    });
  },

  create: function(args){
    $('#applet').html("ssh -L ${localport}:${remoteip}:${remoteport} ${username}@${host}".substitute(args)).fadeIn();
    var t = [
'<applet archive="/applet/steam.jar?v=' + new Date().getTime() + '" id="tunnel" code="Tunnel" codebase="/applet/steam.jar" width="1" height="1">',
  '<param name="host" value="${host}" />',
  '<param name="remoteip" value="${remoteip}" />',
  '<param name="localport" value="${localport}" />',
  '<param name="remoteport" value="${remoteport}" />',
  '<param name="username" value="${username}" />',
  '<param name="js" value="tunnel" />',      
'</applet>'].join('');
    $('#applet').html(t.substitute(args));
  }
};

$(document).ready(function(){

  function getArgs(){
    return {
      host: $('#host').val(),
      remoteip: $('#remoteip').val(),
      remoteport: $('#remoteport').val(),
      username: $('#username').val(),
      localport: $('#localport').val(),
      type: $('#type').val(),
      screensize: $('#screensize').val(),
      lang: $('#lang').val(),
      windowtitle: "SteamEngine"
    };
  }

  tunnel.subscribe("Init", function(){
    console.log("Init");
    display.create(getArgs());
  });

  tunnel.subscribe("Error", function(msg){
    alert(msg);
  });

  $('#startButton').click(function(){
    tunnel.create(getArgs());
  });

});
    </script>
  </body>
</html>
